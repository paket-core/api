<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <meta charset="utf-8">
        <title>Tavili pilot</title>
        <meta name="description" content="Web app for the Tavili pilot">
        <style>
            #nojs{
                position: absolute;
                top: 0px;
                left: 0px;
                width: 100%;
                background: yellow;
                color: red;
            }
            #map{
                width: 45%;
                float: left;
                height: 20em;
            }
            #log{
                width: 45%;
                float: right;
                background: yellow;
                color: black;
            }
        </style>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
        <script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script type="text/javascript">

function log(msg){
    console.log(msg);
    if('string' === typeof msg){
        $('#log').prepend(
            $('<div>').text(new Date().toLocaleTimeString() + ' - ' + msg)
        );
    }
};

function get(url, data, callback){
    $.ajax({
        url: url,
        dataType: 'jsonp',
        data: data,
        success:function(data){
            if(null !== data && 'string' === typeof data.error) log(data.error);
            callback(data);
        },
        error:function(){
            log('Unable to retrieve ' + url);
        }
    });
};

$(function(){
    $('#nojs').remove();
    log('js detected');

    // Initialize, center and zoom map
    var map = L.map('map').setView([32.0695, 34.7987], 13);
    L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png',{
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'examples.map-9ijuk24y'
    }).addTo(map);

    // Get and mark nearby packages
    var center = prompt('center', '32.0695:34.7987');
    map.setView(center.split(':'), 13);
    var radius = prompt('radius', '0.01');
    L.circle(center.split(':'), radius * 100000, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5
    }).addTo(map).bindPopup('your range');
    log('getting packages');
    get('packages.jsonp', {'center': center, 'radius': radius}, function(packages){
        $.each(packages, function(idx, hash){
            get('package.jsonp', {id: hash}, function(pos){
                log('got package ' + hash.substring(0, 10));
                L.marker([pos[0], pos[1]]).addTo(map).bindPopup(pos.join(':'));
            });
        });
    });
});
        </script>
    </head>
    <body>
        <div id="nojs">Either you have JavaScript disabled, or we have a serious bug.</div>
        <div id="map"></div>
        <div id="log"></div>
    </body>
</html>
<!--
vim: ft=javascript
-->
