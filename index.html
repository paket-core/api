<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <meta charset="utf-8">
        <title>Tavili pilot</title>
        <meta name="description" content="Web app for the Tavili pilot">
        <style>
            #nojs{
                position: absolute;
                top: 0px;
                left: 0px;
                width: 100%;
                background: yellow;
                color: red;
            }
            #map{
                height: 50em;
            }
            #log{
                background: yellow;
                color: black;
            }
        </style>
        <script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css">
        <link rel="stylesheet" href="MarkerCluster.css">
        <link rel="stylesheet" href="MarkerCluster.Default.css">
        <script src="leaflet.markercluster.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script type="text/javascript">

function log(msg){
    console.log(msg);
    if('string' === typeof msg){
        $('#log').prepend(
            $('<div>').text(new Date().toLocaleTimeString() + ' - ' + msg)
        );
    }
};

function get(url, data, callback){
    $.ajax({
        url: url,
        dataType: 'jsonp',
        data: data,
        success:function(data){
            if(null !== data && 'string' === typeof data.error) log(data.error);
            callback(data);
        },
        error:function(){
            log('Unable to retrieve ' + url);
        }
    });
};

function addmarkertolayer(layer, latlng, iconname, text){
    var icon =  L.icon({
        iconUrl: 'images/' + iconname + '.png',
        iconSize: [32, 32],
        iconAnchor: [1, 30],
    });
    var marker = L.marker([latlng[0], latlng[1]], {'icon': icon}).bindPopup(text);
    layer.addLayer(marker);
}

var map;
function getdeliveries(position, range){
    log('getting deliveries');
    get('deliveriesinrange.jsonp', {'lat': position.lat, 'lng': position.lng, 'radius': range}, function(deliveries){
        var fromMarkers = new L.MarkerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 50 });
        var toMarkers = new L.MarkerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 50 });

        L.circle(position, range * 110000,{
            color: 'red',
            weight: '0.5',
            fillColor: '#f00',
            fillOpacity: 0.1
        }).addTo(map);

        $.each(deliveries, function(idx, hash){
            get('delivery.jsonp', {id: hash}, function(delivery){
                log('got delivery ' + hash + ':' + delivery['fromLatlng'] + delivery['time']);
                var popuptext = 'id:' + idx + " from\nroute:" + delivery['time'] + 'min';
                addmarkertolayer(fromMarkers, delivery['fromLatlng'], 'green_flag_icon', popuptext);
                addmarkertolayer(toMarkers, delivery['toLatlng'], 'pink_flag_icon', popuptext);
            });
        });
        map.addLayer(fromMarkers);
        map.addLayer(toMarkers);
    });
}

function getcurrentposition(callback, manual){
    // Manual prompting for non mobile devices
    // TODO Should be done with cookie
    if('undefined' !== typeof(manual) || /i686/i.test(navigator.userAgent)){
        var position = prompt('position', '32.0695:34.7987').split(':');
        callback({'lat': position[0], 'lng': position[1]}, 0);
    }else{
        map.on('locationerror', function onLocationError(e){
            log(e.message, e);
            return getcurrentposition(callback, true);
        });
        map.on('locationfound', function(e){
            callback(e.latlng, e.accuracy);
        });
        map.locate({setView: true, maxZoom: 14, timeout: 3000});
    }
}

$(function(){
    $('#nojs').remove();
    log('js detected');

    // Initialize, center and zoom map
    map = L.map('map').setView([32.0695, 34.7987], 13);
    L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png',{
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'examples.map-9ijuk24y'
    }).addTo(map);

    getcurrentposition(function(latlng, accuracy){
        var radius = accuracy / 2;
        var meIcon =  L.icon({
            iconUrl: 'images/pink_pin_icon.png',
            iconSize: [32, 32],
            iconAnchor: [9, 30],
        });
        L.marker(latlng, {icon: meIcon}).addTo(map).bindPopup('you are ' + radius + ' meters from here');

        var range = prompt('range', '0.05');
        getdeliveries(latlng, range);
    });
});
        </script>
    </head>
    <body>
        <div id="nojs">Either you have JavaScript disabled, or we have a serious bug.</div>
        <div id="map"></div>
        <div id="log"></div>
    </body>
</html>
<!--
vim: ft=javascript
-->
